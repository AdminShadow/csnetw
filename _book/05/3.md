# 三、TCP协议

## 3.1 TCP协议的特点

1. TCP是面向连接（虚连接）的传输层协议。
2. 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的。
3. TCP提供可靠交付的服务，无差错、不丢失、不重复、按序到达。
4. TCP提供全双工通信。
   - 发送缓存：准备发送的数据&已发送但尚未收到确认的数据
   - 接收缓存：按序到达但尚未被接受应用程序读取的数据&不按序到达的数据
5. TCP面向字节流：TCP把应用程序交下来的数据看成仅仅是一连串的无结构的字节流[^3]。

## 3.2 TCP报文段

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-45dfc2a45334e966.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- 序号：在一个TCP连接中传送的字节流中的每一个字节都按顺序编号，本字段表示本报文段所发送数据的第一个字节的序号。
- 确认号：期望收到对方下一个报文段的第一个数据字节的序号。若确认号为N，则证明到序号N-1为止的所有数据都已正确收到。
- 数据偏移（首部长度）：TCP报文段的数据起始处距离TCP报文段的起始处有多远，以4B位单位，即1个数值是4B。

- 紧急位URG：URG=1时，标明此报文段中有紧急数据，是高优先级的数据，应尽快传送，不用在缓存里排队，配合紧急指针字段使用。
- 复位RST：RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立传输链接。
- 确认位ACK：ACK=1时确认号有效，在连接建立后所有传送的报文段都必须把ACK置为1。
- 推送位PSH：PSH=1时，接收方尽快交付接收应用进程，不再等到缓存填满再向上交付。
- 同步位SYN：SYN=1时，表明是一个连接请求/连接接受报文。
- 终止位FIN：FIN=1时，表明此报文段发送方数据已发完，要求释放连接。
- 窗口：指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量。
- 检验和：检验首部+数据，检验时要加上12B伪首部，第四个字段为6。
- 紧急指针：URG=1时才有意义，指出本报文段中紧急数据的字节数。
- 选项：最大报文段长度MSS、窗口扩大、时间戳、选择确认…

## 3.3 TCP连接管理

TCP连接传输三个阶段：连接建立、数据传送、连接释放

### 3.3.1 TCP连接的建立

TCP连接的建立采用客户服务器方式，主动发起连接建立的应用进程叫做客户，而被动等待连接建立的应用进程叫服务器。

假设运行在一台主机（客户）上的一个进程想与另一台主机（服务器）上的一个进程建立一条连接，客户应用进程首先通知客户TCP，他想建立一个与服务器上某个进程之间的连接，客户中的TCP会用以下步骤与服务器中的TCP建立一条TCP连接：

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-da92c7bbd8abe19d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1. 客户端发送连接请求报文段，无应用层数据。SYN=1，seq=x(随机)
2. 服务器端为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，无应用层数据。SYN=1，ACK=1，seq=y(随机)，ack=x+1
3. 客户端为该TCP连接分配缓存和变量，并向服务器端返回确认的确认，可以携带数据。SYN=0，ACK=1，seq=x+1，ack=y+1

服务器端的资源是在完成第二次握手时分配的，而客户端的资源是在完成第三次握手时分配的，这就使得服务器易于收到SYN洪泛攻击

>SYN洪泛攻击发生在OSI第四层，这种方式利用TCP协议的特性，就是三次握手。攻击者发送TCP SYN，SYN是TCP三次握手中的第一个数据包，而当服务器返回ACK后，该攻击者就不对其进行再确认，那这个TCP连接就处于挂起状态，也就是所谓的半连接状态，服务器收不到再确认的话，还会重复发送ACK给攻击者。这样更加会浪费服务器的资源。攻击者就对服务器发送非常大量的这种TCP连接，由于每一个都没法完成三次握手，所以在服务器上，这些TCP连接会因为挂起状态而消耗CPU和内存，最后服务器可能死机，就无法为正常用户提供服务了。

### 3.3.2 TCP连接的释放

参与一条TCP连接的两个进程中的任何一个都能终止该连接，连接结束后，主机中的“资源”（缓存和变量）将被释放

1. 客户端发送连接释放报文段，停止发送数据，主动关闭TCP连接。FIN=1，seq=u
2. 服务器端回送一个确认报文段，客户到服务器这个方向的连接就释放了——半关闭状态。ACK=1，seq=v，ack=u+1
3. 服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接。FIN=1，ACK=1，seq=w，ack=u+1
4. 客户端回送一个确认报文段，再等到时间等待计时器设置的2MSL（最长报文段寿命）后，连接彻底关闭。ACK=1，seq=u+1，ack=w+1

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-1b74fb15bdd8e87e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 3.4 TCP可靠[^4]传输

TCP实现可靠传输的机制包括校验、序号、确认和重传，其中校验与UDP校验一样，增加伪首部

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-3a8d06ae840277d4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1. 序号

一个字节占一个序号。序号字段指的是一个报文段第一个字节的序号。

2. 确认

TCP首部的确认号是期望收到对方的下一个报文段的数据的第一个字节的序号。如果接收方B已收到第一个报文段,此时B希望收到的下一个报文段的数据是从第3个字节开始的，那么B发送给A的报文中的确认号字段应为3。发送方缓存区会继续存储那些已发送但未收到确认的报文段，以便在需要时重传。TCP默认使用累计确认

3. 重传

确认重传不分家，TCP的发送方在规定的时间内没有收到确认就要重传已发送的报文段。超时重传

TCP采用自适应算法，动态改变重传时间RTTs（加权平均往返时间）。

冗余ACK（冗余确认）：每当比期望序号大的失序报文段到达时，发送一个冗余ACK，指明下一个期待字节的序号。

发送方已发送1，2，3，4，5报文段
接收方收到1，返回给1的确认（确认号为2的第一个字节）
接收方收到3，仍返回给1的确认（确认号为2的第一个字节）
接收方收到4，仍返回给1的确认（确认号为2的第一个字节）
接收方收到5，仍返回给1的确认（确认号为2的第一个字节）
发送方收到3个对于报文段1的冗余ACK：认为2报文段丢失，重传2号报文段快速重传

## 3.5 TCP流量控制

在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，即接收窗口rwnd（接收方设置确认报文段的窗口字段来将rwnd通知给发送方），发送方的发送窗口取接收窗口rwnd和拥塞窗口cwnd的最小值。

TCP利用滑动窗口机制实现流量控制。发送窗口大小可以动态变化

A向B发送数据，连接建立时，B告诉A：“我的rwnd=400（字节）”，设每一个报文段100B，报文段序号初始值为1。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-2654c91566d000a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- TCP为每一个连接设有一个持续计时器，只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器。
- 若持续计时器设置的时间到期，就发送一个零窗口探测报文段。接收方收到探测报文段时给出现在的窗口值。
- 若窗口仍然是0，那么发送方就重新设置持续计时器。

## 3.6 TCP拥塞控制

拥塞控制是指防止过多的数据注入网络，保证网络中的路由器或链路不至过载。

出现拥塞的条件：对资源需求的总和>可用资源

网络中有许多资源同时呈现供应不足→网络性能变坏→网络吞吐量将随输入负荷增大而下降

发送方在确定发送报文段的速率时，既要根据接收方的接收能力，又要从全局考虑不要使网络发生堵塞，因此，TCP协议要求发送方维护以下两个窗口：

1. 接收窗口rwnd：接收方根据接受缓存设置的值，并告知给发送方，反映接收方容量。
2. 拥塞窗口cwnd：发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络当前容量。

发送窗口的上限值应取接收窗口rwnd和拥塞窗口较小的一个，即
$$
发送窗口的上限值= min(rwnd,cwnd)
$$

### 3.6.1 慢开始和拥塞避免

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-b0e95afafd0c7003.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

一个传输轮次：指发送了一批报文段并收到它们的确认的时间。或一个往返时延RTT。或开始发送一批拥塞窗口内的报文段到开始发送下一批拥塞窗口内的报文段的时间。



### 3.6.2 快重传和快恢复

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-72f1030cdad68286.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)







[^1]: 复用：应用层所有的应用进程都可以通过传输层再传输到网络层。
[^2]: 分用：传输层从网络层收到数据后交付指明的应用进程。
[^3]: 流：流入到进程或从进程流出的字节序列。
[^4]: 可靠：保证接收方进程从缓存区读出的字节流与发送方发出的字节流是完全一样的。

