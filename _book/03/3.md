# 三、流量控制与可靠传输机制

较高的发送速度和较低的接收能力的不匹配，会造成传输出错，因此流量控制也是数据链路层的一项重要工作。数据链路层的流量控制是点对点的，而传输层的流量控制是端到端的。

- 数据链路层流量控制手段：接收方收不下就不回复确认。
- 传输层流量控制手段：接收端给发送端一个窗口公告。

滑动窗口有以下重要特性：

- 停止-等待协议：发送窗口大小=1，接收窗口大小=1；
- 后退N帧协议：发送窗口大小>1，接收窗口大小=1；
- 选择重传协议：发送窗口大小>1，接收窗口大小>1；

**若采用n个比特对帧编号，那么发送窗口的尺寸W~T~应满足：$1≤W_T≤2^n-1$。因为发送窗口尺寸过大，就会使得接收方无法区别新帧和旧帧。**

## 3.1 停止-等待流量控制

每发送完一个帧就停止发送，等待对方的确认，在收到确认后再发送下一个帧。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-095f1607c9e13d5e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

除了比特出差错，底层信道还会出现丢包[^1]问题

“停止-等待”就是每发送完一个分组就停止发送，等待对方确认，在收到确认后再发送下一个分组。其操作简单，但信道利用率较低
$$
U=\frac{T_D}{T_D+RTT+T_A}
$$
信道利用率是指发送方在一个发送周期内，有效地发送数据所需要的时间占整个发送周期的比率。即
$$
U=(L/C)/T
$$

>例题：一个信道的数据传输率为4kb/s，单向传播时延为30ms，如果使停止-等待协议的信道最大利用率达到80%，要求的数据帧长度至少为（ ）。
>
>$80\% = \frac{L/4}{L/4+2x30ms}$
>
>L=960bit

## 3.2 后退N帧协议(GBN)

GBN发送方：

- 上层要发送数据时，发送方先检查发送窗口是否已满，如果未满，则产生一个帧并将其发送；如果窗口已满，发送方只需将数据返回给上层，暗示上层窗口已满。上层等一会再发送。（实际实现中，发送方可以缓存这些数据，窗口不满时再发送帧）。
- GBN协议中，对n号帧的确认采用累积确认的方式，标明接收方已经收到n号帧和它之前的全部帧。
- 协议的名字为后退N帧/回退N帧，来源于出现丢失和时延过长帧时发送方的行为。就像在停等协议中一样，定时器将再次用于恢复数据帧或确认帧的丢失。如果出现超时，发送方重传所有已发送但未被确认的帧。

GBN接收方：

- 如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ACK，并将该帧中的数据部分交付给上层。
- 其余情况都丢弃帧，并为最近按序接收的帧重新发送ACK。接收方无需缓存任何失序帧，只需要维护一个信息：expectedseqnum（下一个按序接收的帧序号）。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-7f3308f6f2bb1982.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

因连续发送数据帧而提高了信道利用率，重传时必须把原来已经正确传送的数据帧重传，是传送效率降低。

>1.数据链路层采用了后退N帧（GBN）协议，发送方已经发送了编号为0～7的帧。当计时器超时时，若发送方只收到0、2、3号帧的确认，则发送方需要重发的帧数是（ ）。
>
>重新发送4、5、6、7帧，即重发的帧数为4
>
>2.主机甲与主机乙之间使用后退N帧协议（GBN）传输数据，甲的发送窗口尺寸为1000，数据帧长为1000字节，信道带宽为100Mb/s，乙每收到一个数据帧立即利用一个短帧（忽略其传输延迟）进行确认，若甲、乙之间的单向传播时延是50ms，则甲可以达到的最大平均数据传输率约为（ ）。
>
>若甲全发但没有接收到确认帧，则发送全部需要$\frac{1000*1000*8b}{100*10^6b/s}=80ms$
>
>甲发送第一个帧收确认帧的时间$2*50ms+\frac{1000*8b}{100*10^6b/s}=100.08ms$
>
>$\frac{1000*1000*8}{100.08ms}=80Mb/s$

## 3.3 选择重传协议(SR)

设置单个确认，同时加大接收窗口，设置接收缓存，缓存乱序到达的帧。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-bb3eec4d70391bc6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

SR发送方：

- 从上层收到数据后，SR发送方检查下一个可用于该帧的序号，如果序号位于发送窗口内􀀀，则发送数据帧；否则就像GBN一样，要么将数据缓存，要么返回给上层之后再传输。
- 如果收到ACK，加入该帧序号在窗口内􀀀，则SR发送方将那个被确认的帧标记为已接收。如果该帧序号是窗口的下界（最左边第一个窗口对应的序号），则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内􀀀的未发送帧，则发送这些帧。
- 每个帧都有自己的定时器，一个超时事件发生后只重传一个帧。

SR接收方：

- SR接收方将确认一个正确接收的帧而不管其是否按序。失序的帧将被缓存，并返回给发送方一个该帧的确认帧【收谁确认谁】，直到所有帧（即序号更小的帧）皆被收到为止，这时才可以将一批帧按序交付给上层，然后向前移动滑动窗口。
- 如果收到了窗口序号外(小于窗口下界)的帧，就返回一个ACK。其他情况，就忽略该帧。

发送窗口最好等于接收窗口。（大了会溢出，小了没意义），即
$$
W_{Tmax}=W_{Rmax}=2^{(n−1)}
$$

>数据链路层采用了选择重传（SR）协议，发送方已经发送了编号为0～3的帧。现已收到1号帧的确认，而0、2号帧依次超时，则发送方需要重传的帧数是（ ）。
>
>重新发送0、2号帧

# 