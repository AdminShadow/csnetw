# 二、IPv4

## 2.1 IPv4分组

### 2.1.1 IPv4分组的格式

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-8c03ac55f8213215.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- 首部长度：单位是4B，最小为5。
- 区分服务：指示期望获得哪种类型的服务。
- 总长度：占16位，首部+数据，单位是1B。
- 生存时间（TTL）：IP分组的保质期。经过一个路由器-1，变成0则丢弃。
- 协议：数据部分的协议。
- 协议：数据部分的协议。
- 首部检验和：只检验首部。
- 源IP地址和目的IP地址:32位。
- 可选字段:0~40B ,用来支持排错、测量以及安全等措施
- 填充:，全0，把首部补成4B的整数倍。

> TCP的字段值为6，UDP字段值为173

### 2.1.2 IP数据报切片

链路层数据帧可封装数据的上限称为最大传送单元MTU

标识：同一数据报的分片使用同一标识。

中间位DF（Don’t Fragment）：

- DF=1，禁止分片
- DF=0，允许分片

最低位MF（More Fragment）：

- MF=1，后面“还有分片”
- MF=0，代表最后一片/没分片

片偏移：指出较长分组分片后，某片在原分组中的相对位置。以8B为单位。除了最后一个分片，每个分片长度一定是8B的整数倍。

> 首部（20B） 数据部分（3800B）需要分片为长度不超过1420B的数据报片。
>
> ![图片.png](https://upload-images.jianshu.io/upload_images/26868451-b6972fbe7c7b322f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 2.2 IPv4地址与NAT

### 2.2.1 IPv4地址

IP地址：全世界唯一的32位/4字节标识符，标识路由器主机的接口。IP地址::={<网络号>,<主机号>}

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-37e7b9252ce932c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

| 网路类别 | 最大可用网络数 | 第一个可用的网络号 | 最后一个可用的网络号 | 每个网络中的最大主机数 |
| -------- | -------------- | ------------------ | -------------------- | ---------------------- |
| A        | $2^7-2$        | 1                  | 126                  | $2^{24}-2$             |
| B        | $2^{14}-1$     | 128.1              | 191.255              | $2^{16}-2$             |
| C        | $2^{21}-1$     | 192.0.1            | 223.255.255          | $2^8-2$                |

有一些IP地址是不能用的，有其特殊的作用，如：

| NetID网络号 | HostID主机号      | 作为IP分组源地址 | 作为IP分组目的地址 | 用途                                                         |
| ----------- | ----------------- | ---------------- | ------------------ | ------------------------------------------------------------ |
| 全0         | 全0               | 可以             | 不可以             | 本网范围内表示主机，路由表中用于表示默认路由（表示整个Internet网络） |
| 全0         | 特定值            | 可以             | 不可以             | 表示本网内某个特定主机                                       |
| 全1         | 全1               | 不可以           | 可以               | 本网广播地址（路由器不转发）                                 |
| 特定值      | 全0               | 不可以           | 不可以             | 网络地址，表示一个网络                                       |
| 特定值      | 全1               | 不可以           | 可以               | 直接广播地址，对特定网络上的所有主机进行广播                 |
| 127         | 任何数（非全0/1） | 可以             | 可以               | 用于本地软件环回测试，称为环回地址                           |

### 2.2.2 网络地址转换(NAT)

网络地址转换NAT（Network Address Translation）：在专用网连接到因特网的路由器上安装NAT软件，安装了NAT软件的路由器叫NAT路由器，它至少有一个有效的外部全球IP地址。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-94f991228de42bac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


此外，为了网络安全，划分出了部分IP地址和私有IP地址，私有IP地址网段如下：

| 地址类别 | 地址范围                    | 网段个数 |
| -------- | --------------------------- | -------- |
| A类      | 10.0.0.0~10.255.255.255     | 1        |
| B类      | 172.16.0.0~172.31.255.255   | 16       |
| C类      | 192.168.0.0~192.168.255.255 | 256      |

路由器对目的地址是私有IP地址的数据报一律不进行转发。

分类的IP地址的弱点：

- IP地址空间的利用率有时很低
- 两级IP地址不够灵活。

## 2.3 子网划分与子网掩码、CDR

### 2.3.1 子网划分

某单位划分子网后，对外仍表现为一个网络，即本单位外的网络看不见本单位内子网的划分。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-c7b9a267ca4e758c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 2.3.2 子网掩码

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-82005d74b264c98b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

路由器转发分组的算法：

1. 提取目的IP地址
2. 是否直接交付
3. 特定主机路由
4. 检测路由表中有无路径
5. 默认路由0.0.0.0
6. 丢弃，报告转发分组出错

### 2.3.3 无分类编址CIDR

无分类域间路由选择CIDR：

1. 消除了传统的A类，B类和C类地址以及划分子网的概念。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-1c69b91ae9a6b8d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

CIDR记法：IP地址后加上“/”，然后写上网络前缀（可以任意长度）的位数。e.g. 128.14.32.0/20

2. 融合子网地址与子网掩码，方便子网划分。

CIDR把网络前缀都相同的连续的IP地址组成一个“CIDR地址块”。

> ![图片.png](https://upload-images.jianshu.io/upload_images/26868451-46f3dd03c3b574f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240) 

使用CIDR时，查找路由表可能得到几个匹配结果（跟网络掩码按位相与），应选择具有最长网络前缀的路由。前缀越长，地址块越小，路由越具体。

将多个子网聚合成一个较大的子网，叫做构成超网，或路由聚合。方法：将网络前缀缩短（所有网络地址取交集）。

## 2.4 ARP、DCHP、ICMP

### 2.4.1 ARP协议

由于在实际网络的链路上传送数据帧时，最终必须使用MAC地址。

ARP协议：完成主机或路由器IP地址到MAC地址的映射。

ARP协议使用过程：

- 检查ARP高速缓存，有对应表项则写入MAC帧，没有则用目的MAC地址为FF-FF-FF-FF-FF-FF的帧封
- 装并广播ARP请求分组，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会向源
- 主机单播一个ARP响应分组，源主机收到后将此映射写入ARP缓存（10-20min更新一次）。

ARP协议4种典型情况：

1. 主机A发给本网络上的主机B：用ARP找到主机B的硬件地址；
2. 主机A发给另一网络上的主机B：用ARP找到本网络上一个路由器（网关）的硬件地址；
3. 路由器发给本网络的主机A：用ARP找到主机A的硬件地址；
4. 路由器发给另一网络的主机B：用ARP找到本网络上的一个路由器的硬件地址。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-32d4b145ae7fc8ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 2.4.2 DHCP协议

动态主机配置协议DHCP是**应用层**协议，使用**客户/服务器**方式，客户端和服务端通过**广播**方式进行交互，基于**UDP**。

DHCP提供即插即用联网的机制，主机可以从服务器动态获取IP地址、子网掩码、默认网关、DNS服务器名称与IP地址，允许地址重用，支持移动用户加入网络，支持在用地址续租。

DHCP工作流程如下：

1. 主机广播DHCP发现报文：试图找到网络中的服务器，服务器获得一个IP地址。
2. DHCP服务器广播DHCP提供报文：服务器拟分配给主机一个IP地址及相关配置，先到先得。
3. 主机广播DHCP请求报文：主机向服务器请求提供IP地址。
4. DHCP服务器广播DHCP确认报文：正式将IP地址分配给主机。

### 2.4.3 ICMP协议

ICMP协议支持主机或路由器：包括差错（或异常）报告和网络探询，分部发送特定ICMP报文

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-7d977368e6456ed5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ICMP差错报告报文（5种）：

- 终点不可达(无法交付)：当路由器或主机不能交付数据报时就向源点发送终点不可达报文。
- 源点抑制(拥塞丢数据)：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。
- 时间超过(TTL=0)：当路由器收到生存时间TTL=0的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
- 参数问题(首部字段有问题)：当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
- 改变路由（重定向）(值得更好的路由)：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

不应发送ICMP差错报文的情况：

- 对ICMP差错报告报文不再发送ICMP差错报告报文。
- 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。
- 对具有组播地址的数据报都不发送ICMP差错报告报文。
- 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

ICMP询问报文:

- 回送请求和回答报文:主机或路由器向特定目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。测试目的站是否可达以及了解其相关状态。
- 时间戳请求和回答报文:请某个主机或路由器回答当前的日期和时间。用来进行时钟同步和测量时间。
- 掩码地址请求和回答报文
- 路由器询问和通告报文

ICMP的应用：

- PING：测试两个主机之间的连通性，使用了ICMP回送请求和回答报文。
- Traceroute：跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文。