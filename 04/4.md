# 四、 路由算法与路由协议

## 4.1 路由算法的分类

R1的路由表/转发表如下：

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-0b42aa03ae4b6ac4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

最佳路由：“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。

路由算法可分为

- 静态路由算法（非自适应路由算法）：管理员手工配置路由信息。优点：简便、可靠，在负荷稳定、拓扑变化不大的网络中运行效果很好，广泛用于高度安全性的军事网络和较小的商业网络。缺点：路由更新慢，不适用大型网络。
- 动态路由算法（自适应路由算法）：路由器间彼此交换信息，按照路由算法优化出路由表项。优点：路由更新快，适用大型网络，及时响应链路费用或网络拓扑变化。缺点：算法复杂，增加网络负担。
  - 链路状态路由算法OSPF(全局性):所有路由器掌握完整的网络拓扑和链路费用信息。
  - 距离向量路由算法RIP(分散性):路由器只掌握物理相连的邻居及链路费用。


## 4.2 分层次的路由选择协议

由于因特网规模很大且许多单位不想让外界知道自己的路由选择协议，但还想连入因特网，可以采用自治系统来解决

自治系统AS：在单一的技术管理下的一组路由器，而这些路由器使用一种AS内部的路由选择协议和共同的度量以确定分组在该AS内的路由，同时还使用一种AS之间的路由协议以确定在AS之间的路由。

一个AS内的所有网络都属于一个行政单位来管辖，一个自治系统的所有路由器在本自治系统内都必须连通。

路由选择协议

- 内部网关协议IGP：一个AS内使用的，如RIP、OSPF
- 外部网关协议EGP：AS之间使用的，如BGP

## 4.3 RIP协议及距离向量算法

### 4.3.1 RIP协议

RIP是一种分布式的基于距离向量的路由选择协议，是因特网的协议标准，最大优点是简单。

RIP协议要求网络中每一个路由器都维护从它自己到其他每一个目的网络的唯一最佳距离[^1]记录（即一组距离）。**RIP协议只适用于小互联网。**

RIP是应用层协议，使用**UDP**传送数据。一个RIP报文最多可包括25个路由，如超过，必须再用一个RIP报文传送。

RIP协议的交换

1. 仅和相邻路由器交换信息。
2. 路由器交换的信息是自己的路由表。
3. 每30秒交换一次路由信息，然后路由器根据新信息更新路由表。若超过180s没收到邻居路由器的通告，则判定邻居没了，并更新自己路由表。

路由器刚开始工作时，只知道直接连接的网络的距离（距离为1），接着每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。

经过若干次更新后，所有路由器最终都会知道到达本自治系统任何一个网络的最短距离和下一跳路由器的地址，即“收敛”。

RIP的特点：当网络出现故障时，要经过比较长的时间(例如数分钟) 才能将此信息传送到所有的路由器，“慢收敛”。

### 4.3.2 距离向量算法

1. 修改相邻路由器发来的RIP报文中所有表项

对地址为X的相邻路由器发来的RIP报文，修改此报文中的所有项目：把“下一跳”字段中的地址改为X，并把所有的“距离”字段+1。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-384f1dbe1bf75ebb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

2. 对修改后的RIP报文中的每一个项目，进行以下步骤：

- R1路由表中若没有Net3，则把该项目填入R1路由表
- R1路由表中若有Net3，则查看下一跳路由器地址：
  - 若下一跳是X，则用收到的项目替换源路由表中的项目；
  - 若下一跳不是X，原来距离比从X走的距离远则更新，否则不作处理。

3. 若180s还没收到相邻路由器X的更新路由表，则把X记为不可达的路由器，即把距离设置为16。

4. 返回

> ![image-20210917215902182](C:\Users\86173\AppData\Roaming\Typora\typora-user-images\image-20210917215902182.png)

>考虑如图所示的子网，该子网使用了距离-向量算法，下面的向量刚刚到达路由器C：来自B的向量为（5，0，8，12，6，2）；来自D的向量为（16，12，6，0，9，10）；来自E的向量为（7，6，3，9，0，4）。经过测量，C到B、D和E的延迟分别为6，3和5，那么C到达所有结点的最短路径是（ ）。
>A．（5，6，0，9，6，2） B．（11，6，0，3，5，8）C．（5，11，0，12，8，9）D．（11，8，0，7，4，9）
>
>![图片.png](https://upload-images.jianshu.io/upload_images/26868451-286803a74a4db43d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
>
>C到B：（11，6，14，18，12，8）
>C到D：（19，15，9，3，12，13）
>C到E：（12，11，8，14，5，9）

## 4.4 OSPF协议及链路状态算法

### 4.4.1 OSPF协议

开放最短路径优先OSPF协议：“开放”标明OSPF协议不是受某一家厂商控制，而是公开发表的；“最短路径优先”是因为使用了Dijkstra提出的最短路径算法SPF。OSPF最主要的特征就是使用分布式的链路状态协议。**OSPF直接用IP数据报传送。**

OSPF的特点：

- 使用洪泛法向自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器。最终整个区域内所有路由器都得到了这个信息的一个副本。
- 发送的信息就是与本路由器相邻的所有路由器的链路状态（本路由器和哪些路由器相邻，以及该链路的度量/代价——费用、距离、时延、带宽等）。
- 只有当链路状态发生变化时，路由器才向所有路由器洪泛发送此信息。最后，所有路由器都能建立一个链路状态数据库，即全网拓扑图。
- 每隔30min，要刷新一次数据库中的链路状态。
- 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF 协议要比距离向量协议RIP 好得多。
- OSPF不存在坏消息传的慢的问题，它的收敛速度很快。

为了使OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域。每一个区域都有一个32 位的区域标识符（用点分十进制表示）。区域也不能太大，在一个区域内的路由器最好不超过200 个。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-df4eb86b93cce272.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 4.4.2 链路状态路由算法

1. 每个路由器发现它的邻居结点【HELLO问候分组】，并了解邻居节点的网络地址。
2. 设置到它的每个邻居的成本度量metric。
3. 构造【DD数据库描述分组】，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
4. 如果DD分组中的摘要自己都有，则邻站不做处理；如果有没有的或者是更新的，则发送【LSR链路状态请求分组】请求自己没有的和比自己更新的信息。
5. 收到邻站的LSR分组后，发送【LSU链路状态更新分组】进行更新。
6. 更新完毕后，邻站返回一个【LSAck链路状态确认分组】进行确认。只要一个路由器的链路状态发生变化：
7. 泛洪发送【LSU链路状态更新分组】进行更新。
8. 更新完毕后，其他站返回一个【LSAck链路状态确认分组】进行确认。
9. 使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径。

## 4.5 BGP协议

BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列AS。当BGP 发言人互相交换了网络可达性的信息后，各BGP 发言人就根据所采用的策略从收到的路由信息中找出到达各AS 的较好路由。

- 与其他AS的邻站BGP发言人交换信息。
- 交换的网络可达性的信息，即要到达某个网络所要经过的一系列AS。
- 发生变化时更新有变化的部分。

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-9f42f6ab38f2b7ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

一个BGP 发言人与其他自治系统中的BGP 发言人要交换路由信息，就要先建立TCP 连接，即通过TCP传送，然后在此连接上交换BGP 报文以建立BGP 会话(session)，利用BGP 会话交换路由信息。**BGP是应用层协议，借助TCP传送。**

BGP协议特点:

- BGP 支持CIDR，因此BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。
- 在BGP 刚刚运行时，BGP 的邻站是交换整个的BGP 路由表。但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处。

BGP-4的四种报文

- OPEN（打开）报文：用来与相邻的另一个BGP发言人建立关系，并认证发送方。
- UPDATE（更新）报文：通告新路径或撤销原路径。
- KEEPALIVE（保活）报文：在无UPDATE时，周期性证实邻站的连通性；也作为OPEN的确认。
- NOTIFICATION（通知）报文：报告先前报文的差错；也被用于关闭连接。

## 4.6 各路由协议的比较 

![图片.png](https://upload-images.jianshu.io/upload_images/26868451-c4fe096badc64e72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)